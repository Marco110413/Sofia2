#!/bin/bash

# Archivos JSON donde se guardan datos
DB_USUARIOS="usuarios.json"
DB_TOKENS="tokens.json"
DB_RETIROS="retiros.json"
DB_HISTORIAL="historial.json"

# FunciÃ³n para registrar usuarios
registrar_usuario() {
    echo "ðŸ”¹ Registro de Usuario"
    read -p "Ingrese nombre de usuario: " usuario
    read -p "Ingrese su clave: " clave
    echo "{ \"usuario\": \"$usuario\", \"clave\": \"$clave\", \"tokens\": 0 }" >> "$DB_USUARIOS"
    echo "âœ… Usuario registrado con Ã©xito."
}

# FunciÃ³n para asignar tokens
asignar_tokens() {
    echo "ðŸ”¹ AsignaciÃ³n de Tokens"
    read -p "Nombre de usuario: " usuario
    read -p "Cantidad de bits utilizados: " bits

    tokens_actuales=$(jq -r ".[] | select(.usuario==\"$usuario\") | .tokens" "$DB_TOKENS")
    if [ -z "$tokens_actuales" ] || [ "$tokens_actuales" == "null" ]; then
        echo "âŒ Usuario no encontrado."
        return
    fi

    nuevos_tokens=$((tokens_actuales + (bits / 1000)))
    jq "map(if .usuario == \"$usuario\" then .tokens = $nuevos_tokens else . end)" "$DB_TOKENS" > temp.json && mv temp.json "$DB_TOKENS"
    echo "âœ… Tokens actualizados: $nuevos_tokens"
}

# FunciÃ³n para convertir tokens a criptomonedas
convertir_tokens() {
    echo "ðŸ”¹ ConversiÃ³n de Tokens a Criptomonedas"
    read -p "Nombre de usuario: " usuario
    read -p "Cantidad de tokens a convertir: " cantidad
    echo "Opciones disponibles: 1) USDT  2) BNB  3) ETH  4) BTC"
    read -p "Seleccione una opciÃ³n: " opcion

    moneda=""
    case $opcion in
        1) moneda="USDT" ;;
        2) moneda="BNB" ;;
        3) moneda="ETH" ;;
        4) moneda="BTC" ;;
        *) echo "âŒ OpciÃ³n invÃ¡lida"; return ;;
    esac

    tokens_actuales=$(jq -r ".[] | select(.usuario==\"$usuario\") | .tokens" "$DB_TOKENS")
    if [ "$cantidad" -gt "$tokens_actuales" ]; then
        echo "âŒ No tienes suficientes tokens."
        return
    fi

    nuevos_tokens=$((tokens_actuales - cantidad))
    jq "map(if .usuario == \"$usuario\" then .tokens = $nuevos_tokens else . end)" "$DB_TOKENS" > temp.json && mv temp.json "$DB_TOKENS"

    echo "{ \"usuario\": \"$usuario\", \"tokens\": \"$cantidad\", \"moneda\": \"$moneda\", \"estado\": \"pendiente\" }" >> "$DB_RETIROS"
    echo "âœ… ConversiÃ³n en proceso. Esperando aprobaciÃ³n."
}

# FunciÃ³n para aprobar/rechazar retiros automÃ¡ticamente
aprobar_retiro() {
    echo "ðŸ”¹ AprobaciÃ³n AutomÃ¡tica de Retiros"

    while IFS= read -r line; do
        usuario=$(echo "$line" | jq -r '.usuario')
        cantidad=$(echo "$line" | jq -r '.tokens')
        moneda=$(echo "$line" | jq -r '.moneda')
        
        # SimulaciÃ³n de aprobaciÃ³n automÃ¡tica (puedes conectar con Binance aquÃ­)
        echo "âœ… Retiro aprobado para $usuario: $cantidad $moneda"

        jq "map(if .usuario == \"$usuario\" and .estado == \"pendiente\" then .estado = \"aprobado\" else . end)" "$DB_RETIROS" > temp.json && mv temp.json "$DB_RETIROS"
        
        # Guardar en historial
        echo "{ \"usuario\": \"$usuario\", \"cantidad\": \"$cantidad\", \"moneda\": \"$moneda\", \"fecha\": \"$(date)\" }" >> "$DB_HISTORIAL"
    done < <(jq -c '.[] | select(.estado == "pendiente")' "$DB_RETIROS")

    echo "ðŸ”¹ Todos los retiros pendientes han sido procesados."
}

# FunciÃ³n para ver historial de transacciones
ver_historial() {
    echo "ðŸ”¹ Historial de Transacciones"
    jq '.' "$DB_HISTORIAL"
}

# FunciÃ³n principal del menÃº
menu() {
    while true; do
        echo "ðŸ“Œ MENÃš PRINCIPAL"
        echo "1ï¸âƒ£ Registrar usuario"
        echo "2ï¸âƒ£ Asignar tokens"
        echo "3ï¸âƒ£ Convertir tokens a criptomonedas"
        echo "4ï¸âƒ£ Aprobar/rechazar retiros automÃ¡ticamente"
        echo "5ï¸âƒ£ Ver historial de transacciones"
        echo "6ï¸âƒ£ Salir"
        read -p "Seleccione una opciÃ³n: " opcion

        case $opcion in
            1) registrar_usuario ;;
            2) asignar_tokens ;;
            3) convertir_tokens ;;
            4) aprobar_retiro ;;
            5) ver_historial ;;
            6) echo "ðŸ‘‹ Saliendo..."; exit ;;
            *) echo "âŒ OpciÃ³n invÃ¡lida" ;;
        esac
    done
}

# Iniciar el menÃº
menu
